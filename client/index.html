<!DOCTYPE html>
<html>
    <head>
        <title>CORONAVIRUS GAMES</title>
        <link rel="stylesheet" type="text/css" href="static/index.css">
        <script src="../../socket.io/socket.io.js"></script>
        <script src="js/draw.js"></script>
    </head>
    <body>
        <div id="wrapper">
            <canvas id="background" width="500" height="500" style="position:
            absolute; z-index: 0;"></canvas>
            <canvas id="ctx" width="500" height="500" style="position: absolute;
            z-index: 1;"></canvas>
        </div>
        <div id="info"><b class='unselectable' id='hp'></b></div>
    </body>
    <script>
        var img = new Image();
        img.src = 'static/bush.png';
        var background = document.getElementById('background').getContext('2d');
        background.fillStyle = '#B0E0E6'; // blue
        var gameMap = [];
        var length = 100;
        for (var i = 0; i < length; i++) {
            let x = Math.round(Math.random());
            gameMap.push(1);
        }
        gameMap[50] = 0;
        gameMap[51] = 0;
        gameMap[52] = 0;
        gameMap[53] = 0;
        gameMap[54] = 0;
        gameMap[55] = 0;

        function loadMap() {
            if (background == null) { return; }
            for (var y = 0; y < 10; y++) {
                for (var x = 0; x < 10; x++) {
                    switch (gameMap[((y * 10) + x)]) {
                        case 0:
                                background.drawImage(img, x * 50 + 15, y * 50 + 20);
                                break;
                        default:
                                background.fillRect(x * 50, y * 50, 50, 50);
                    }
                }
            }
        }

        window.onload = function() {
            requestAnimationFrame(loadMap);
        }
    </script>
    <script>
        var socket = io.connect('http://localhost:8899');

        var cvs = document.getElementById('ctx');
        var ctx = cvs.getContext('2d');

        var alive = true;

        function clearCtx() {
            ctx.clearRect(0, 0, cvs.width, cvs.height);
        }

        function getCursorPosition(canvas, event) {
            const rect = canvas.getBoundingClientRect()
            const retX = event.clientX - rect.left
            const retY = event.clientY - rect.top
            return {x: retX, y: retY};
        }

        function eventToIndex(eventNum) {
            switch(eventNum) {
                case 65:
                    return 0;
                    break;
                case 68:
                    return 1;
                    break;
                case 87:
                    return 2;
                    break;
                case 83:
                    return 3;
                    break;
                default:
                    return -1;
                    break;
            }
        }

        window.addEventListener('keydown', function(e) {
            var index = eventToIndex(e.keyCode);
            if (alive && index != -1) {
                socket.emit('keydown', index);
            }
        });

        window.addEventListener('keyup', function(e) {
            var index = eventToIndex(e.keyCode);
            if (alive && index != -1) {
                socket.emit('keyup', index);
            }
        });

        cvs.addEventListener('click', function(e) {
            if (alive) {
                socket.emit('shoot', getCursorPosition(cvs, e));
            }
        });

        socket.on('update', function(players) {
            clearCtx();
            for (let id in players) {
                var color, bColor;
                var player = players[id];
                if (id === socket.id) {
                    color = 'blue';
                    bColor = 'blue';
                    var hp = document.getElementById('hp');
                    hp.innerHTML = ('HP: ' + player.hp.toString());
                }
                else {
                    color = 'red';
                    bColor = 'black';
                    drawHP(ctx, player);
                }
                drawObj(ctx, player, color);
                for (let bID in player.bullets) {
                    drawObj(ctx, player.bullets[bID], bColor);
                }
            }
        });

        socket.on('dead', function() {
            alive = false;
            alert('You are dead.');
        });

    </script>
</html>